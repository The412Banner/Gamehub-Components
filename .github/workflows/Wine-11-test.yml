name: Build Wine 11.3 for Winlator

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [x86_64, aarch64]
      fail-fast: false
    
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Fetch Wine 11.3 Source
        run: |
          wget https://github.com/Kron4ek/Wine-Builds/releases/download/11.3/wine-11.3-src.tar.gz
          tar -xzf wine-11.3-src.tar.gz
          mv wine-11.3/* .
          rm -rf wine-11.3 wine-11.3-src.tar.gz

      - name: Fetch GameNative Build Scripts and Patches
        run: |
          git clone --depth 1 --branch proton_10.0 https://github.com/GameNative/proton-wine.git gamenative_repo
          mv gamenative_repo/build-scripts .
          mkdir -p android
          mv gamenative_repo/android/patches ./android/patches
          rm -rf gamenative_repo
          chmod +x build-scripts/*.sh
    
      - name: Set up build environment
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git wget curl unzip flex bison gettext \
            autoconf automake libtool pkg-config mingw-w64 \
            gcc-multilib g++-multilib libfreetype6-dev \
            libfreetype6-dev:i386 libpng-dev libpng-dev:i386 \
            zlib1g-dev zlib1g-dev:i386
      
      - name: Download and extract termuxfs for ${{ matrix.arch }}
        run: |
          mkdir -p $HOME/termuxfs/${{ matrix.arch }}
          cd $HOME/termuxfs/${{ matrix.arch }}
          wget https://github.com/GameNative/termux-on-gha/releases/download/build-20260218/termuxfs-${{ matrix.arch }}.tar
          tar -xf termuxfs-${{ matrix.arch }}.tar
      
      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ~/Android/Sdk/ndk/27.3.13750724
          key: android-ndk-r27d
      
      - name: Set up Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          mkdir -p $HOME/Android/Sdk/ndk
          cd $HOME/Android/Sdk/ndk
          wget https://dl.google.com/android/repository/android-ndk-r27d-linux.zip
          unzip -q android-ndk-r27d-linux.zip
          mv android-ndk-r27d 27.3.13750724
      
      - name: Cache LLVM MinGW toolchain
        id: cache-llvm-mingw
        uses: actions/cache@v4
        with:
          path: ~/toolchains/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64
          key: bylaws-llvm-mingw-20250920
      
      - name: Set up LLVM MinGW toolchain
        if: steps.cache-llvm-mingw.outputs.cache-hit != 'true'
        run: |
          mkdir -p $HOME/toolchains
          cd $HOME/toolchains
          wget https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz
          tar -xf llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz
      
      - name: Run autogen.sh
        run: |
          bash autogen.sh
      
      - name: Build sysvshm library for ${{ matrix.arch }}
        if: matrix.arch == 'aarch64'
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            bash build-scripts/build-step-x86_64.sh --build-sysvshm
          else
            bash build-scripts/build-step-arm64ec.sh --build-sysvshm
          fi
      
      - name: Configure build for ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            bash build-scripts/build-step-x86_64.sh --configure
          else
            bash build-scripts/build-step-arm64ec.sh --configure
          fi
      
      - name: Build Wine for ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            bash build-scripts/build-step-x86_64.sh --build
          else
            bash build-scripts/build-step-arm64ec.sh --build
          fi
      
      - name: Install Wine for ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            bash build-scripts/build-step-x86_64.sh --install
          else
            bash build-scripts/build-step-arm64ec.sh --install
          fi
      
      - name: Download prefixPack.txz for ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            wget https://github.com/GameNative/bionic-prefix-files/raw/main/prefixPack-x86_64.txz -O $GITHUB_WORKSPACE/prefixPack.txz
          else
            wget https://github.com/GameNative/bionic-prefix-files/raw/main/prefixPack-arm64ec.txz -O $GITHUB_WORKSPACE/prefixPack.txz
          fi
      
      - name: Generate profile.json files
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            ARCH_NAME="x86_64"
          else
            ARCH_NAME="arm64ec"
          fi
          
          # Generate Wine profile.json
          cat > $GITHUB_WORKSPACE/profile.json << EOF
          {
            "type": "Wine",
            "versionName": "11.3-${ARCH_NAME}",
            "versionCode": 0,
            "description": "Wine 11.3 ${ARCH_NAME} - Windows compatibility layer",
            "files": [],
            "wine": {
              "binPath": "bin",
              "libPath": "lib",
              "prefixPack": "prefixPack.txz"
            }
          }
          EOF
      
      - name: Package build artifacts
        run: |
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            OUTPUT_DIR="$HOME/compiled-files-x86_64"
            ARCH_NAME="x86_64"
          else
            OUTPUT_DIR="$HOME/compiled-files-aarch64"
            ARCH_NAME="arm64ec"
          fi
          
          cd $OUTPUT_DIR
          
          # Create Wine WCP - wcp.xz format
          cp $GITHUB_WORKSPACE/prefixPack.txz .
          cp $GITHUB_WORKSPACE/profile.json .
          tar cJf wine-11.3-$ARCH_NAME.wcp.xz bin lib share prefixPack.txz profile.json
          mv wine-11.3-$ARCH_NAME.wcp.xz $GITHUB_WORKSPACE/
      
      - name: Upload Wine build artifacts for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: wine-11.3-${{ matrix.arch }}
          path: wine-11.3-*.wcp.xz
          retention-days: 30
  
  release:
    needs: build
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name "*.wcp.xz" -exec cp {} release/ \;
          ls -lah release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-11.3-${{ github.run_number }}
          name: Wine 11.3 (Build ${{ github.run_number }})
          files: release/*
          draft: false
          prerelease: false
          body: |
            ## Wine 11.3 Build
            
            ### Architectures
            - x86_64 (Intel/AMD 64-bit)
            - arm64ec (ARM64EC)
            
            ### WCP Files
            **Wine Type:**
            - `wine-11.3-x86_64.wcp.xz`
            - `wine-11.3-arm64ec.wcp.xz`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
