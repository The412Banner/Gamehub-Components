name: DXVK 2.7.1 Builds

on:
  workflow_dispatch:

jobs:
  # ==================================================================
  # JOB 1: DXVK 2.7.1 x86/x64
  # ==================================================================
  build-dxvk-standard:
    name: Build DXVK 2.7.1 (${{ matrix.type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        type: [standard, async, gplasync]
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 wget git xz-utils python3 meson ninja-build build-essential unzip zip

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Clone, Patch, and Build DXVK
        run: |
          git clone --recursive https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          git checkout v2.7.1
          
          if [ "${{ matrix.type }}" == "async" ]; then
            wget -q https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-2.7.1-1.patch
            git apply dxvk-gplasync-2.7.1-1.patch
            echo "VERSION_NAME=2.7.1-async" >> $GITHUB_ENV
            echo "DESC_TEXT=DXVK 2.7.1 (Async)" >> $GITHUB_ENV
          elif [ "${{ matrix.type }}" == "gplasync" ]; then
            wget -q https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-2.7.1-1.patch
            git apply dxvk-gplasync-2.7.1-1.patch
            echo "VERSION_NAME=2.7.1-gplasync" >> $GITHUB_ENV
            echo "DESC_TEXT=DXVK 2.7.1 (GPLAsync)" >> $GITHUB_ENV
          else
            echo "VERSION_NAME=2.7.1-standard" >> $GITHUB_ENV
            echo "DESC_TEXT=DXVK 2.7.1 (Standard)" >> $GITHUB_ENV
          fi
          
          sed -i 's/ninja/ninja -j 2/g' package-release.sh
          ./package-release.sh v2.7.1 ../dxvk-built --no-package

      - name: Package
        run: |
          mkdir -p packaging/system32
          mkdir -p packaging/syswow64
          cp -r dxvk-built/dxvk-v2.7.1/x64/* packaging/system32/
          cp -r dxvk-built/dxvk-v2.7.1/x32/* packaging/syswow64/
          
          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "${{ env.DESC_TEXT }}",
            "files": [
              { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
              { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
              { "source": "system32/d3d8.dll", "target": "\${system32}/d3d8.dll" },
              { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
              { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
              { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
              { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
              { "source": "syswow64/d3d8.dll", "target": "\${syswow64}/d3d8.dll" },
              { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
              { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
            ]
          }
          EOF
          
          cd packaging
          tar -cJf ../dxvk-${{ env.VERSION_NAME }}.wcp .
          zip -r ../dxvk-${{ env.VERSION_NAME }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dxvk-${{ env.VERSION_NAME }}
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 2: DXVK 2.7.1 ARM64EC
  # ==================================================================
  build-dxvk-arm64ec:
    name: Build DXVK 2.7.1 ARM64EC (${{ matrix.type }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        type: [standard, async, gplasync]
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl xz-utils jq git build-essential python3 pkg-config zstd meson ninja-build wget unzip zip

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup LLVM-MinGW
        run: |
          LLVM_MINGW_TAG="20251104"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          tar -xf llvm.tar.xz
          echo "$PWD/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

      - name: Clone, Patch, and Configure Cross-Files
        run: |
          git clone --recursive https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          git checkout v2.7.1
          
          if [ "${{ matrix.type }}" == "async" ]; then
            wget -q https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-2.7.1-1.patch
            git apply dxvk-gplasync-2.7.1-1.patch
            echo "VERSION_NAME=2.7.1-async-arm64ec" >> $GITHUB_ENV
            echo "DESC_TEXT=DXVK 2.7.1 ARM64EC (Async)" >> $GITHUB_ENV
          elif [ "${{ matrix.type }}" == "gplasync" ]; then
            wget -q https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-2.7.1-1.patch
            git apply dxvk-gplasync-2.7.1-1.patch
            echo "VERSION_NAME=2.7.1-gplasync-arm64ec" >> $GITHUB_ENV
            echo "DESC_TEXT=DXVK 2.7.1 ARM64EC (GPLAsync)" >> $GITHUB_ENV
          else
            echo "VERSION_NAME=2.7.1-standard-arm64ec" >> $GITHUB_ENV
            echo "DESC_TEXT=DXVK 2.7.1 ARM64EC (Standard)" >> $GITHUB_ENV
          fi
          cd ..

          cat <<EOF > arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat <<EOF > x86.txt
          [binaries]
          c = 'i686-w64-mingw32-clang'
          cpp = 'i686-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

      - name: Build
        run: |
          cd dxvk
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-ec -j 2
          ninja -C build-x86 -j 2

      - name: Package
        run: |
          mkdir -p packaging/system32
          mkdir -p packaging/syswow64
          
          copy_dll() {
            SRC_DIR=$1
            DEST_DIR=$2
            cp "dxvk/$SRC_DIR/src/d3d11/d3d11.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d10/d3d10core.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d9/d3d9.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d8/d3d8.dll" "$DEST_DIR/" || true 
            cp "dxvk/$SRC_DIR/src/dxgi/dxgi.dll" "$DEST_DIR/"
          }
          copy_dll "build-ec" "packaging/system32"
          copy_dll "build-x86" "packaging/syswow64"
          
          llvm-strip --strip-all packaging/system32/*.dll
          llvm-strip --strip-all packaging/syswow64/*.dll

          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "${{ env.DESC_TEXT }}",
            "files": [
              { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
              { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
              { "source": "system32/d3d8.dll", "target": "\${system32}/d3d8.dll" },
              { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
              { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
              { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
              { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
              { "source": "syswow64/d3d8.dll", "target": "\${syswow64}/d3d8.dll" },
              { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
              { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
            ]
          }
          EOF
          
          cd packaging
          tar --zstd -cf ../dxvk-${{ env.VERSION_NAME }}.wcp .
          zip -r ../dxvk-${{ env.VERSION_NAME }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dxvk-${{ env.VERSION_NAME }}
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 3: Release
  # ==================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-dxvk-standard, build-dxvk-arm64ec]
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Set Release Variables
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          READABLE_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "TAG_NAME=dxvk-2.7.1-nightly-$TIMESTAMP" >> $GITHUB_ENV
          echo "RELEASE_NAME=DXVK 2.7.1 Builds - $READABLE_DATE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.RELEASE_NAME }}
          prerelease: true
          make_latest: false
          body: |
            ### ðŸš€ DXVK 2.7.1 Builds
            
            This release contains 6 targeted builds of DXVK v2.7.1:
            1. **DXVK 2.7.1 (Standard)**
            2. **DXVK 2.7.1 (Async)**
            3. **DXVK 2.7.1 (GPLAsync)**
            4. **DXVK 2.7.1 ARM64EC (Standard)**
            5. **DXVK 2.7.1 ARM64EC (Async)**
            6. **DXVK 2.7.1 ARM64EC (GPLAsync)**
            
            Packaged and ready for Winlator (`.wcp` and `.zip`).
            
            *Note: As of DXVK 2.7, upstream removed the state cache that `gplAsyncCache` relied on. Therefore, both the "Async" and "GPLAsync" variants here use the exact same updated GPLAsync patch from Ph42oN, but they are built and labeled distinctively to easily slot into your launcher configurations.*
          files: |
            ./artifacts/*.wcp
            ./artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
