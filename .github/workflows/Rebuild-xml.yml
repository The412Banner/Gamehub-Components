name: Generate Filtered Component Lists

on:
  workflow_dispatch:
  push:
    paths:
      - 'sp_winemu_all_components12.xml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get install -y xmlstarlet

      - name: Extract and Filter Data
        run: |
          INPUT="sp_winemu_all_components12.xml"
          XML_OUT="clean_links.xml"
          TXT_OUT="component_list.txt"

          # 1. Initialize Files
          echo '<?xml version="1.0" encoding="utf-8"?>' > "$XML_OUT"
          echo '<map>' >> "$XML_OUT"

          echo "WINEMU COMPONENT DOWNLOAD LIST" > "$TXT_OUT"
          echo "Filter: .tzst, .exe, .msi only" >> "$TXT_OUT"
          echo "Generated: $(date)" >> "$TXT_OUT"
          echo "================================================" >> "$TXT_OUT"

          # 2. Process XML
          xmlstarlet sel -t -m "//string[@name]" -v "concat(@name, '|||', .)" -n "$INPUT" | while IFS='|||' read -r FILENAME JSON; do
            
            if [ -z "$FILENAME" ]; then continue; fi

            # Extract and clean the URL
            URL=$(echo "$JSON" | grep -oP '(?<="download_url":")[^"]*' | head -1 | sed 's/\\//g')

            # Only proceed if URL matches your specific extensions
            if [[ "$URL" =~ \.(tzst|exe|msi)$ ]]; then
               # Add to Clean XML
               echo "    <string name=\"$FILENAME\">$URL</string>" >> "$XML_OUT"
               
               # Add to Easy-to-Read Text Document
               echo "NAME: $FILENAME" >> "$TXT_OUT"
               echo "LINK: $URL" >> "$TXT_OUT"
               echo "------------------------------------------------" >> "$TXT_OUT"
            fi
          done

          echo '</map>' >> "$XML_OUT"

      - name: Commit Updated Files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add clean_links.xml component_list.txt
          
          if git diff --staged --quiet; then
            echo "No relevant changes found."
          else
            git commit -m "Automated: Filtered links to .tzst, .exe, and .msi"
            git push
          fi
