name: Box64 Hybrid (Official + Pipetto)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 9 * * *'

jobs:
  build-hybrid:
    name: Build Box64 (Hybrid)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip

      - name: Setup Android NDK (r26b)
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # THE HYBRID MERGE STEP
      # ----------------------------------------------------------------
      - name: Clone & Merge
        run: |
          # 1. Clone Official (Upstream)
          git clone https://github.com/ptitSeb/box64 source
          cd source
          
          # 2. Add Pipetto as a remote
          git remote add pipetto https://github.com/Pipetto-crypto/box64
          git fetch pipetto
          
          # 3. Configure Git identity (needed for merge)
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # 4. Merge Pipetto's main branch into Official
          # We use --no-edit to accept default merge message
          echo "Attempting to merge Pipetto/main into Official..."
          git merge pipetto/main --no-edit || { echo "MERGE FAILED: Conflict detected!"; exit 1; }
          
          echo "Merge successful!"

      - name: Get Version Info
        id: version
        run: |
          cd source
          MAJOR=$(grep '#define BOX64_MAJOR' src/box64version.h | awk '{print $3}')
          MINOR=$(grep '#define BOX64_MINOR' src/box64version.h | awk '{print $3}')
          REVISION=$(grep '#define BOX64_REVISION' src/box64version.h | awk '{print $3}')
          VERSION="$MAJOR.$MINOR.$REVISION"
          COMMIT=$(git rev-parse --short HEAD)
          
          # Name it "Hybrid" so you know it's the mixed version
          FULL_V="Box64-Hybrid-${VERSION}-${COMMIT}-bionic"
          
          echo "FULL_VERSION=$FULL_V" >> $GITHUB_ENV
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Configure and Build (Bionic)
        run: |
          mkdir build && cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} \
            -DANDROID=1 -DBIONIC=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DTERMUX=0 -DHAVE_TRACE=0 -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64

      - name: Package
        run: |
          cd build
          
          cat <<EOF > profile.json
          {
            "type": "Box64",
            "versionName": "${{ env.FULL_VERSION }}",
            "versionCode": 0,
            "description": "Box64 Hybrid (Official + Pipetto)\nMerged Commit: ${{ steps.version.outputs.commit }}",
            "files": [{"source": "box64", "target": "\${bindir}/box64"}]
          }
          EOF
          
          mkdir pkg_content
          cp box64 pkg_content/
          cp profile.json pkg_content/
          
          # ZIP (Raw)
          cd pkg_content
          zip -r "../${{ env.FULL_VERSION }}.zip" .
          
          # WCP (Winlator)
          tar -cf ../temp.tar .
          cd ..
          mv temp.tar temp_archive
          xz -9 -c temp_archive > "${{ env.FULL_VERSION }}.wcp"

      - uses: actions/upload-artifact@v4
        with:
          name: box64-hybrid
          path: |
            build/*.wcp
            build/*.zip

  release:
    name: Release Hybrid Build
    runs-on: ubuntu-latest
    needs: build-hybrid
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "box64-hybrid-$(date +'%Y-%m-%d')"
          name: "Box64 Hybrid: $(date +'%Y-%m-%d')"
          make_latest: true
          body: |
            ### ðŸ§¬ Box64 Hybrid Build
            This build takes the **Official** version and merges **Pipetto's** latest changes on top of it.
            
            * **Base:** ptitSeb/box64
            * **Merged:** Pipetto-crypto/box64
            * **Optimization:** Bionic (Android 12)
            
            _If this build exists, the merge was successful. If the workflow failed, the two repos have conflicting code._
          files: |
            ./artifacts/*.wcp
            ./artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
