name: All-in-One Emulation Nightly

on:
  schedule:
    - cron: '0 9 * * *' # Runs every day at 9 AM UTC
  workflow_dispatch:

jobs:
  # ==================================================================
  # JOB 1: Box64 Matrix (All 6 Variants)
  # ==================================================================
  build-box64-matrix:
    name: Build Box64 ${{ matrix.source }} (${{ matrix.type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        type: [Native, Bionic, WOW64]
        source: [Official, Hybrid]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip

      - name: Cache Android NDK
        if: matrix.type != 'WOW64'
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/android-ndk-r26b
          key: android-ndk-r26b-linux

      - name: Cache LLVM-MinGW (WOW64)
        if: matrix.type == 'WOW64'
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/llvm-mingw-20240619-ucrt-ubuntu-20.04-x86_64
          key: llvm-mingw-20240619

      - name: Setup Toolchain (Android)
        if: matrix.type != 'WOW64'
        run: |
          if [ ! -d "$PWD/android-ndk-r26b" ]; then
            wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
            unzip -q android-ndk-r26b-linux.zip
          fi
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          if [ "${{ matrix.type }}" == "Bionic" ]; then
            echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang" >> $GITHUB_ENV
          else
            echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang" >> $GITHUB_ENV
          fi

      - name: Setup Toolchain (WOW64 MinGW)
        if: matrix.type == 'WOW64'
        run: |
          LLVM_MINGW_VERSION=20240619
          if [ ! -d "$PWD/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64" ]; then
            wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
            tar -xf llvm-mingw-*.tar.xz
          fi
          echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_PATH

      - name: Clone & Merge Source
        run: |
          git clone https://github.com/ptitSeb/box64 source
          cd source
          if [ "${{ matrix.source }}" == "Hybrid" ]; then
            git remote add pipetto https://github.com/Pipetto-crypto/box64
            git fetch pipetto
            git config user.email "action@github.com"
            git config user.name "GitHub Action"
            git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; }
          fi

      - name: Configure and Build
        run: |
          mkdir build && cd build
          if [ "${{ matrix.type }}" == "WOW64" ]; then
            cmake ../source -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc -DWOW64=1 -DARM_DYNAREC=1 -DCMAKE_BUILD_TYPE=Release
            make -j$(nproc) wowbox64
          else
            CMAKE_ARGS=""
            if [ "${{ matrix.type }}" == "Bionic" ]; then CMAKE_ARGS="-DBIONIC=1 -DTERMUX=0 -DHAVE_TRACE=0"; fi
            cmake ../source -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} -DANDROID=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DCMAKE_BUILD_TYPE=Release $CMAKE_ARGS
            make -j$(nproc)
            ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64
          fi

      - name: Package
        run: |
          mkdir -p $GITHUB_WORKSPACE/dist
          COMMIT=$(cd source && git rev-parse --short HEAD)
          VERSION="Box64-${{ matrix.source }}-${{ matrix.type }}-$COMMIT"
          if [ "${{ matrix.type }}" == "WOW64" ]; then
            cd build/wowbox64-prefix/src/wowbox64-build
            mkdir -p system32 && cp wowbox64.dll system32/
            echo '{"type": "WOWBox64"}' > profile.json
            zip -r "$GITHUB_WORKSPACE/dist/$VERSION.zip" .
            tar -cJf "$GITHUB_WORKSPACE/dist/$VERSION.wcp" .
          else
            cd build
            mkdir pkg && cp box64 pkg/
            echo '{"type": "Box64"}' > pkg/profile.json
            cd pkg
            zip -r "$GITHUB_WORKSPACE/dist/$VERSION.zip" .
            tar -cJf "$GITHUB_WORKSPACE/dist/$VERSION.wcp" .
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: box64-${{ matrix.source }}-${{ matrix.type }}
          path: dist/*

  # ==================================================================
  # JOB 2: FEXCore Nightly
  # ==================================================================
  build-fex:
    name: Build FEXCore
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y ca-certificates curl xz-utils jq git zip build-essential python3 pkg-config cmake zstd dos2unix perl tar unzip meson ninja-build wget
      
      - name: Setup Toolchain
        run: |
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/20251104/llvm-mingw-20251104-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo mkdir -p /opt/llvm-mingw && sudo tar -C /opt/llvm-mingw --strip-components=1 -xJf llvm.tar.xz
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
      
      - name: Build FEX
        run: |
          git clone --recursive https://github.com/FEX-Emu/FEX.git source
          cd source
          mkdir build && cd build
          cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake -DMINGW_TRIPLE="aarch64-w64-mingw32" ..
          ninja -j$(nproc)
      
      - name: Package
        run: |
          mkdir pkg && find . -name "*.dll" -exec cp {} pkg/ \;
          cd pkg && zip -r ../FEX-Nightly.zip . && tar -cJf ../FEX-Nightly.wcp .
      
      - uses: actions/upload-artifact@v4
        with:
          name: fex-nightly
          path: |
            *.zip
            *.wcp

  # ==================================================================
  # JOB 3: VKD3D-Proton Matrix (Standard & ARM64EC)
  # ==================================================================
  build-vkd3d-matrix:
    name: Build VKD3D-Proton (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64ec]
    steps:
      - name: Install Deps
        run: sudo apt-get update && sudo apt-get install -y git meson ninja-build wget unzip zip python3
      
      - name: Setup LLVM-MinGW
        run: |
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/20251104/llvm-mingw-20251104-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo mkdir -p /opt/llvm-mingw && sudo tar -C /opt/llvm-mingw --strip-components=1 -xJf llvm.tar.xz
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
      
      - name: Build
        run: |
          git clone --recursive https://github.com/HansKristian-Work/vkd3d-proton src
          cd src
          if [ "${{ matrix.arch }}" == "x64" ]; then
            cat <<EOF > ../cross.txt
          [binaries]
          c = 'x86_64-w64-mingw32-clang'
          cpp = 'x86_64-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF
          else
            cat <<EOF > ../cross.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
          fi
          meson setup build --cross-file ../cross.txt -Dbuildtype=release
          ninja -C build
      
      - name: Package
        run: |
          mkdir -p dist/system32
          find src/build -name "*.dll" -exec cp {} dist/system32/ \;
          cd dist && zip -r ../vkd3d-${{ matrix.arch }}.zip . && tar -cJf ../vkd3d-${{ matrix.arch }}.wcp .
      
      - uses: actions/upload-artifact@v4
        with:
          name: vkd3d-${{ matrix.arch }}
          path: |
            *.zip
            *.wcp

  # ==================================================================
  # JOB 4: DXVK Standard Matrix (Vanilla, Async, GPLAsync)
  # ==================================================================
  build-dxvk-standard-matrix:
    name: Build DXVK Standard (${{ matrix.variant }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        variant: [Vanilla, Async, GPLAsync]
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 wget git xz-utils python3 meson ninja-build build-essential unzip zip

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Clone & Patch
        run: |
          git clone --recursive https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          LATEST_TAG=$(git describe --tags --abbrev=0)
          COMMIT=$(git rev-parse --short HEAD)
          
          if [ "${{ matrix.variant }}" == "GPLAsync" ]; then
            wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
            git apply dxvk-gplasync-master.patch
          elif [ "${{ matrix.variant }}" == "Async" ]; then
            # NOTE: Add your specific Async patch URL below if you have one for 2.7.1
            echo "Async selected, skipping patch download until URL is provided"
          fi
          
          echo "VERSION_NAME=${LATEST_TAG}-${{ matrix.variant }}-$COMMIT" >> $GITHUB_ENV

      - name: Build
        run: |
          cd dxvk
          sed -i 's/ninja/ninja -j 2/g' package-release.sh
          ./package-release.sh master ../built --no-package

      - name: Package
        run: |
          mkdir -p packaging/system32 packaging/syswow64
          cp -r built/dxvk-master/x64/* packaging/system32/
          cp -r built/dxvk-master/x32/* packaging/syswow64/
          
          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "DXVK ${{ matrix.variant }}",
            "files": [
              { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
              { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
              { "source": "system32/d3d8.dll", "target": "\${system32}/d3d8.dll" },
              { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
              { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
              { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
              { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
              { "source": "syswow64/d3d8.dll", "target": "\${syswow64}/d3d8.dll" },
              { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
              { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
            ]
          }
          EOF
          
          cd packaging
          tar -cJf ../DXVK-Std-${{ env.VERSION_NAME }}.wcp .
          zip -r ../DXVK-Std-${{ env.VERSION_NAME }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-std-${{ matrix.variant }}
          path: |
            *.zip
            *.wcp

  # ==================================================================
  # JOB 5: DXVK ARM64EC Matrix (Vanilla, Async, GPLAsync)
  # ==================================================================
  build-dxvk-arm64ec-matrix:
    name: Build DXVK ARM64EC (${{ matrix.variant }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        variant: [Vanilla, Async, GPLAsync]
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl xz-utils jq git build-essential python3 pkg-config zstd meson ninja-build wget unzip zip

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup LLVM-MinGW
        run: |
          LLVM_MINGW_TAG="20251104"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          tar -xf llvm.tar.xz
          echo "$PWD/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64/bin" >> $GITHUB_PATH

      - name: Clone & Patch
        run: |
          git clone --recursive https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          LATEST_TAG=$(git describe --tags --abbrev=0)
          COMMIT=$(git rev-parse --short HEAD)
          
          if [ "${{ matrix.variant }}" == "GPLAsync" ]; then
            wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
            git apply dxvk-gplasync-master.patch
          elif [ "${{ matrix.variant }}" == "Async" ]; then
            # NOTE: Add your specific Async patch URL below if you have one for 2.7.1
            echo "Async selected, skipping patch download until URL is provided"
          fi
          
          echo "VERSION_NAME=${LATEST_TAG}-${{ matrix.variant }}-arm64ec-$COMMIT" >> $GITHUB_ENV

      - name: Configure Cross-Files
        run: |
          cat <<EOF > arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat <<EOF > x86.txt
          [binaries]
          c = 'i686-w64-mingw32-clang'
          cpp = 'i686-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

      - name: Build
        run: |
          cd dxvk
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-ec -j 2
          ninja -C build-x86 -j 2

      - name: Package
        run: |
          mkdir -p packaging/system32
          mkdir -p packaging/syswow64
          
          copy_dll() {
            SRC_DIR=$1
            DEST_DIR=$2
            cp "dxvk/$SRC_DIR/src/d3d11/d3d11.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d10/d3d10core.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d9/d3d9.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d8/d3d8.dll" "$DEST_DIR/" || true 
            cp "dxvk/$SRC_DIR/src/dxgi/dxgi.dll" "$DEST_DIR/"
          }
          
          copy_dll "build-ec" "packaging/system32"
          copy_dll "build-x86" "packaging/syswow64"
          
          llvm-strip --strip-all packaging/system32/*.dll
          llvm-strip --strip-all packaging/syswow64/*.dll

          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "DXVK ARM64EC ${{ matrix.variant }}",
            "files": [
              { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
              { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
              { "source": "system32/d3d8.dll", "target": "\${system32}/d3d8.dll" },
              { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
              { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
              { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
              { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
              { "source": "syswow64/d3d8.dll", "target": "\${syswow64}/d3d8.dll" },
              { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
              { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
            ]
          }
          EOF
          
          cd packaging
          tar --zstd -cf ../DXVK-ARM64EC-${{ env.VERSION_NAME }}.wcp .
          zip -r ../DXVK-ARM64EC-${{ env.VERSION_NAME }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-arm64ec-${{ matrix.variant }}
          path: |
            *.zip
            *.wcp

  # ==================================================================
  # JOB 6: DXVK-NVAPI
  # ==================================================================
  build-dxvk-nvapi:
    name: Build DXVK-NVAPI
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y git meson ninja-build python3 pkg-config wget unzip zip
      
      - name: Setup LLVM-MinGW
        run: |
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/20251104/llvm-mingw-20251104-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo mkdir -p /opt/llvm-mingw && sudo tar -C /opt/llvm-mingw --strip-components=1 -xJf llvm.tar.xz
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
          
      - name: Build & Package
        run: |
          git clone --recursive https://github.com/jp7677/dxvk-nvapi.git src
          cd src
          cat <<EOF > ../cross.txt
          [binaries]
          c = 'x86_64-w64-mingw32-clang'
          cpp = 'x86_64-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF
          meson setup build --cross-file ../cross.txt -Dbuildtype=release
          ninja -C build
          cd ..
          mkdir pkg
          find src/build -name "*.dll" -exec cp {} pkg/ \;
          echo '{"type": "NVAPI"}' > pkg/profile.json
          cd pkg && zip -r ../nvapi.zip . && tar -cJf ../nvapi.wcp .
          
      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-nvapi
          path: |
            *.zip
            *.wcp

  # ==================================================================
  # JOB 7: Create Combined Nightly Release
  # ==================================================================
  create-release:
    name: Create Nightly Release
    runs-on: ubuntu-latest
    needs: [build-box64-matrix, build-fex, build-vkd3d-matrix, build-dxvk-standard-matrix, build-dxvk-arm64ec-matrix, build-dxvk-nvapi]
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Delete old release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete nightly --cleanup-tag -y || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Emulation Nightly Build"
          prerelease: true
          body: |
            ### ðŸš€ Nightly Summary
            This release contains the latest automated builds for all components.
            
            - **Box64**: Official & Hybrid Variants
            - **FEXCore**: Nightly Build
            - **VKD3D-Proton**: Standard & ARM64EC
            - **DXVK**: Standard & ARM64EC (Vanilla, Async, GPLAsync)
            - **DXVK-NVAPI**: Latest
          files: |
            ./artifacts/*.wcp
            ./artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
